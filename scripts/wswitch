#!/bin/bash
# wswitch: sync current workspace to main workspace for preview (only files modified in last 7 days)
# Usage:
#   cd any_project_subdir_in_workspace
#   wswitch

# === COLORS ===
RED="\033[1;31m"
GREEN="\033[1;32m"
YELLOW="\033[1;33m"
BLUE="\033[1;34m"
BOLD="\033[1;1m"
RESET="\033[0m"

# === CONFIGURATION VARIABLES ===
WORK_ROOT="/Users/luoking/Desktop/Projects/Work"
MAIN_WS="$WORK_ROOT/workspace-main"
PREVIEW_BRANCH="luoking/preview"

PROJECTS=("luoking-creatify-coding" "main-web-ui" "webserver")
declare -A PROJECT_EXCLUDE
PROJECT_EXCLUDE["luoking-creatify-coding"]=".git/"
PROJECT_EXCLUDE["main-web-ui"]=".git/ node_modules/ dist/ .vite/ .cache/"
PROJECT_EXCLUDE["webserver"]=".git/ logs/ tmp/"

# ----------------------------
# 1️⃣ 自动查找当前 workspace 根目录
CUR_DIR=$(pwd)
CUR_WS_ROOT=""
while [[ "$CUR_DIR" != "/" ]]; do
    BASENAME=$(basename "$CUR_DIR")
    if [[ "$BASENAME" == workspace-* ]]; then
        CUR_WS_ROOT="$CUR_DIR"
        break
    fi
    CUR_DIR=$(dirname "$CUR_DIR")
done

if [[ -z "$CUR_WS_ROOT" ]]; then
    echo -e "${RED}Error:${RESET} cannot find workspace root (must be under $WORK_ROOT/workspace-*)"
    exit 1
fi

if [[ "$CUR_WS_ROOT" == "$MAIN_WS" ]]; then
    echo -e "${RED}Error:${RESET} cannot run wswitch in main workspace"
    exit 1
fi

CUR_WS_NAME=$(basename "$CUR_WS_ROOT")
echo -e "${BLUE}Detected workspace:${RESET} ${BOLD}$CUR_WS_NAME${RESET}"

# ----------------------------
# 2️⃣ 检查项目目录是否存在
for PROJECT in "${PROJECTS[@]}"; do
    if [ ! -d "$MAIN_WS/$PROJECT" ] || [ ! -d "$CUR_WS_ROOT/$PROJECT" ]; then
        echo -e "${RED}Error:${RESET} project folder $PROJECT does not exist in main or current workspace"
        exit 1
    fi
done

# ----------------------------
# 3️⃣ 切换 main workspace 到 PREVIEW_BRANCH
cd "$MAIN_WS" || exit
git fetch origin
if git show-ref --quiet refs/heads/$PREVIEW_BRANCH; then
    git switch "$PREVIEW_BRANCH"
    echo -e "${GREEN}Switched${RESET} main workspace to branch ${BOLD}$PREVIEW_BRANCH${RESET}"
else
    git switch -c "$PREVIEW_BRANCH"
    echo -e "${GREEN}Created and switched${RESET} main workspace to branch ${BOLD}$PREVIEW_BRANCH${RESET}"
fi

# ----------------------------
# 4️⃣ 清理 main workspace 上次 preview 修改
echo -e "${YELLOW}Cleaning main workspace...${RESET}"
git restore .
git clean -fd
echo -e "${GREEN}Main workspace cleaned.${RESET}"

# ----------------------------
# 5️⃣ 同步当前 workspace 最近一周修改的文件到 main workspace
echo -e "${YELLOW}Syncing $CUR_WS_NAME -> main workspace (only files modified in last 7 days)...${RESET}"
for PROJECT in "${PROJECTS[@]}"; do
    EXCLUDES=${PROJECT_EXCLUDE[$PROJECT]}
    RSYNC_EXCLUDE=""
    for E in $EXCLUDES; do
        RSYNC_EXCLUDE="$RSYNC_EXCLUDE --exclude=$E"
    done

    # Find modified files and convert absolute paths to relative paths
    SRC_DIR="$CUR_WS_ROOT/$PROJECT"
    TMP_FILE_LIST=$(mktemp)
    
    # Find files and convert to relative paths (using sed to strip the SRC_DIR prefix)
    find "$SRC_DIR" -type f -mtime -7 2>/dev/null | sed "s|^$SRC_DIR/||" > "$TMP_FILE_LIST"
    
    if [[ -s "$TMP_FILE_LIST" ]]; then
        FILE_COUNT=$(wc -l < "$TMP_FILE_LIST" | tr -d ' ')
        echo -e "${BLUE}Found ${FILE_COUNT} modified file(s) in ${PROJECT}${RESET}"
        
        # Use the temp file with relative paths for rsync
        rsync -av $RSYNC_EXCLUDE --files-from="$TMP_FILE_LIST" "$SRC_DIR/" "$MAIN_WS/$PROJECT/" 2>&1 | grep -v "^$" || true
        echo -e "${GREEN}Synced project:${RESET} $PROJECT"
        rm -f "$TMP_FILE_LIST"
    else
        echo -e "${BLUE}No recent changes to sync for project:${RESET} $PROJECT"
        rm -f "$TMP_FILE_LIST"
    fi
done

echo -e "${BOLD}${GREEN}Sync complete.${RESET} Main workspace is now on branch ${BOLD}$PREVIEW_BRANCH${RESET}"
